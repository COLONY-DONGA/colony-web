<!DOCTYPE html>

<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<<<<<<< HEAD
    <link rel="stylesheet" href="../static/css/qaDetail.css" />
    <link rel="stylesheet" href="../static/css/headerfooter.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
=======
    <link rel="stylesheet" href="/css/qaDetail.css" />
>>>>>>> main
    <title>질문 세부 페이지</title>
  </head>

  <body>
    <!--  로그인 유저 닉네임-->
    <div sec:authorize="isAuthenticated()">
      <span
        class="member-nickname"
        sec:authentication="principal.nickname"
        style="display: none"
      ></span>
    </div>
    <div sec:authorize="isAnonymous()">
      <span class="member-nickname" value="" style="display: none"></span>
    </div>

    <div th:replace="~{layouts/header :: header}"></div>
    <br />
    <br />
    <br />

    <div class="qadetail-frame">
<<<<<<< HEAD
      <div class="q-box">
        <div class="horizontal-line"></div>
        <div class="q-head">
          <div class="question-title" th:text="${postDto.title}">title</div>
          <div class="question-info">
            <span id="post-writer" class="question-info-writer" th:text="${postDto.createdBy}"
              >작성자</span
            >
            <span class="small-line"> | </span>
            <span class="question-info-date" th:text="${postDto.updatedAt}">date</span>
          </div>

          <br />
          <br />
          <hr />
          <!--<tr class="article-info">
              <th>날짜</th>
              <td th:text="${postDto.updatedAt}">date</td>
            </tr> -->

          <!--내용칸-->
        </div>

        <div class="question-area" th:text="${postDto.content}">
          Q. question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area Q.
          question area Q. question area Q. question area Q. question area Q. question area
        </div>

        <input id="postId" type="hidden" th:value="${postDto.postId}" />
        <!--포스트아이디-->

        ----------<!--질문 첨부파일 이미지+이미지명 출력파트-->
        <div class="file-box">
          <!-- Loop through the file list -->
          <div th:each="file : ${postDto.imageDtoList}">
            <div class="file-img">
              <img th:src="|/images/${file.storeImageName}|" alt="이미지" />
            </div>
          </div>
        </div>

        <!--버튼바들-->
        <div class="tool-box" id="question-tool-box">
          <div class="btn">
            <button class="qabtn" id="qabtn">
              <i class="fa-keyboard-o"></i>
              답변하기
            </button>
            <!--<button class="listbtn" id="listbtn">목록</button>-->
            <button class="editbtn" id="post-editbtn">수정</button>
            <button class="deletebtn" id="post-deletebtn">
              <i class="fa fa-trash"></i>
            </button>
            <!--<a href="#" class="btn green rounded">Button</a>-->
          </div>
=======
      <section class="article-detail table-common con row">
        <table class="cell" border="1">
          <colgroup>
            <col width="100px" />
          </colgroup>
          <tbody>
            <tr class="article-title">
              <th>제목</th>
              <td class="question-title" th:text="${postDto.title}">title</td>
              <th>작성자</th>
              <td id="post-writer" class="question-title" th:text="${postDto.createdBy}">name</td>
              <!--시큐리티 변수-->
            </tr>
            <tr class="article-info">
              <th>날짜</th>
              <td th:text="${postDto.updatedAt}">date</td>
              <!--수정~-->
              <th>좋아요</th>
              <td id="qlikeCount">0</td>
              <button id="qlikeBtn" class="likeButton">좋아요</button>
            </tr>
            <tr class="article-body">
              <!--내용칸-->
              <td colspan="4" th:text="${postDto.content}">Q. question area</td>
            </tr>
          </tbody>
        </table>
        <input id="postId" type="hidden" th:value="${postDto.postId}" />
      </section>
      <!--질문 첨부파일 이미지+이미지명 출력파트-->
      <div class="file-box">
        <!-- Loop through the file list -->
        <div th:each="file : ${postDto.imageDtoList}">
          <div class="file-img">
<!--            <img th:src="|/images/${file.storeImageName}|" alt="이미지" />-->
            <img th:src="${file.s3Url}" alt="이미지" />
          </div>
>>>>>>> main
        </div>
      </div>
      <br />
      <br />

<<<<<<< HEAD
      <br />

      <div class="answer-box" id="answer-box">
        <div class="horizontal-line"></div>
        <div class="a-head">
          <div class="answer-title">
            <span class="answer-label">답변</span>
            <!--타임리프 필요-->
            <span class="answer-number">1</span>
          </div>
          <div class="answer-info">
            <span id="answer-writer" class="answer-info-writer" th:text="${postDto.createdBy}"
              >작성자</span
            >
            <span class="small-line"> | </span>
            <span class="answer-info-date" th:text="${answerDto.updatedAt}">date</span>
          </div>
        </div>

        <div th:each="answer : ${answerList}" class="answer-text" id="answer-box-[[${answer.id}]]">
          <!-- 답변데이터가 타임리프로 이곳에 들어갈 예정입니다 -->
          <div class="answer-area" th:text="${'A. : ' + answer.content}">
            A.answer content A.answer content A.answer content A.answer content A.answer content
          </div>
        </div>

        <!--파일-->
        --파일,이미지 기능

        <div class="tool-box" id="answer-tool-box">
          <button class="heart-button"><i class="fa fa-heart"></i></button>
          <div class="likecount" id="like">1</div>
          <div class="btn">
            <button class="editbtn" id="answer-editbtn">수정</button>
            <button class="deletebtn" id="answer-deletebtn">
              <i class="fa fa-trash"></i>
            </button>
            <!--<a href="#" class="btn green rounded">Button</a>-->
          </div>
        </div>

        <br />

        <div class="comments-container">
          <ul id="comments-list" class="comments-list">
            <!-- 댓글이 여기에 추가될 예정 -->
          </ul>
          <!-- 새댓글 작성부분 -->
          <div class="input-box">
            <div class="inputframe">
              <br />

              <input
                type="text"
                class="input-text"
                id="newComment"
                placeholder="새 댓글을 입력하세요"
              />
              <button class="new-comment-btn" id="add-comment-button">작성</button>
            </div>
          </div>
        </div>
      </div>
=======
      <div class="answer-text-box">
        <div class="answer-text" th:text="테스트"></div>
      </div>

      <!--파일-->

      <div class="btn">
        <button type="button" class="qabtn" id="qabtn">답변 등록</button>
        <button class="listbtn" id="listbtn">목록</button>
        <button class="editbtn" id="editbtn">수정</button>
        <button class="deletebtn" id="deletebtn">삭제</button>
        <!--<a href="#" class="btn green rounded">Button</a>-->
      </div>
>>>>>>> main
    </div>
    <div id="footer"></div>

    <script>
      // [[${userName}]] 이런식으로 타임리프 식으로 사용 가능
      let userName = $('#member-nickname').val(); // 로그인 유저
      let name = $('#post-writer').val(); // post 작성자
      let postId = $('#postId').val();

      var qabtn = document.getElementById('qabtn'); //답변등록 버튼
      qabtn.addEventListener('click', function () {
        window.open('/answer/' + postId, 'aEnroll');
      });

      var listbtn = document.getElementById('listbtn'); //목록 버튼
      listbtn.addEventListener('click', function () {
        location.href = '/post-list';
      });

      var postEditbtn = document.getElementById('post-editbtn'); //게시글 수정 버튼
      editbtn.addEventListener('click', function () {
        location.href = 'edit-post/' + postId;
      });

      var answerEditbtn = document.getElementById('answer-editbtn'); //답변글 수정 버튼
      editbtn.addEventListener('click', function () {
        location.href = 'answer-post/' + answerId;
      });

      var postDeletebtn = document.getElementById('post-deletebtn'); //게시글 삭제 버튼
      deletebtn.addEventListener('click', function () {
        location.href = '/delete-post/' + postId;
      });

<<<<<<< HEAD
      var answerDeletebtn = document.getElementById('answer-deletebtn'); //답변글 삭제 버튼
      deletebtn.addEventListener('click', function () {
        location.href = '/delete-answer/' + answerId;
      });

=======
>>>>>>> main
      if (userName != name || userName === '') {
        editbtn.style.display = 'none';
        deletebtn.style.display = 'none';
        //관리자일때도 권한 추가
        if (userName === '관리자') {
          //관리자 이름을 어떻게 받더라....
          editbtn.style.display = 'block';
          deletebtn.style.display = 'block';
        }
      }

      //좋아요 기능 구현(질문글 좋아요)
      $(document).ready(function () {
        $('.heart-button').click(function () {
          const $parent = $(this).parent('.answer');
          const answerId = $parent.data('answer-id');

          // json 형식으로 ajax 요청을 보냅니다.
          $.ajax({
            type: 'POST',
            url: '/좋아요 url',
            contentType: 'application/json',
            data: JSON.stringify({ answerId: answerId, userName: userName }),
            success: function (response) {
              const $likeCount = $parent.find('.likecount');
              const currentLikeCount = parseInt($likeCount.text());
              $likeCount.text(currentLikeCount + 1);
            },
            error: function (xhr, status, error) {
              console.error('Error:', status, error);
            },
          });
        });
      });

      //css 관련 코드!  css 관련 코드!  css 관련 코드!  css 관련 코드!  css 관련 코드!

      // 문서가 로드되면 요소의 크기를 자동으로 조정합니다.
      window.addEventListener('load', function () {
        adjustQuestionAreaHeight();
      });

      // 뷰포트 크기가 변경될 때마다 요소의 크기를 다시 조정합니다.
      window.addEventListener('resize', function () {
        adjustQuestionAreaHeight();
      });

      // 요소의 높이를 조정하는 함수
      function adjustQuestionAreaHeight() {
        var qBox = document.getElementById('q-box');
        var questionArea = document.getElementById('question-area');
        var maxHeight = qBox.offsetHeight;
        questionArea.style.height = maxHeight + 'px';
      }

      // answer-area css부분
      document.addEventListener('DOMContentLoaded', function () {
        const answerAreas = document.querySelectorAll('.answer-area');
        for (const answerArea of answerAreas) {
          adjustAnswerAreaHeight(answerArea);
        }
      });

      // answer-area의 높이를 자동으로 조절하는 함수
      function adjustAnswerAreaHeight(element) {
        element.style.height = 'auto'; // 높이 초기화
      }

      //답변 생성 부분!!

      function fetchAnswers() {
        const postId = $('#postId').val();
        $.ajax({
          type: 'GET',
          url: `/api/answers/${postId}`,
          success: function (response) {
            processAnswersFromServer(response); // 가져온 답변 데이터를 처리하는 함수 호출
          },
          error: function (error) {
            console.error('답변 데이터를 가져오는데 실패하였습니다:', error);
          },
        });
      }

      function addAnswer(answer) {
        const answerList = document.getElementById('answer-list');

        const answerElement = `
          <div class="answer-text" id="answer-box-${answer.id}">
            <div class="answer-area">A. : ${answer.content}</div>
          </div>
        `;
        answerList.innerHTML += answerElement;
      }

      function addAnswers(answers) {
        const answerList = document.getElementById('answer-list');
        answerList.innerHTML = ''; // 기존 답변을 모두 지우고 새로운 답변을 추가할 것입니다.

        answers.forEach((answer) => {
          addAnswer(answer);
        });
      }

      // 서버에서 답변을 받은 후 이 함수를 호출합니다.
      function processAnswersFromServer(answers) {
        addAnswers(answers);
      }

      //댓글 작성 기능!!!
      function onWriteButtonClick() {
        const newCommentInput = document.getElementById('newComment');
        const newCommentText = newCommentInput.value;

        const newComment = {
          name: '사용자',
          content: newCommentText,
          replies: [],
        };

        // 새 댓글을 서버로 전송!
        $.ajax({
          type: 'POST',
          url: '/api/comments',
          contentType: 'application/json', // JSON 형식으로 데이터를 보내도록 설정합니다.
          data: JSON.stringify(newComment), // JSON 형식으로 직렬화하여 데이터를 보냅니다.
          success: function () {
            addComments(); // 댓글 작성 후 댓글 목록을 새로고침합니다.
            newCommentInput.value = ''; // 입력 필드를 초기화합니다.
          },
          error: function (error) {
            console.error('댓글 작성 오류:', error);
          },
        });
      }

      // 대댓글 작성 기능
      function onClickAddReplyButton(event) {
        const button = event.target.closest('.fa-reply');
        if (!button) return;

        const commentIndex = button.dataset.commentIndex;
        const commentItem = button.closest('li');
        const replyList = commentItem.querySelector('.reply-list');
        const inputReply = replyList.querySelector('.inputReply');
        const newReplyText = inputReply.value;

        const newReply = {
          name: userName,
          content: newReplyText,
        };

        // 새 대댓글을 서버로 전송!
        $.ajax({
          type: 'POST',
          url: `/api/comments/${commentIndex}/replies`,
          contentType: 'application/json', // JSON 형식으로 데이터를 보내도록 설정합니다.
          data: JSON.stringify(newReply), // JSON 형식으로 직렬화하여 데이터를 보냅니다.
          success: function () {
            addComments(); // 대댓글 작성 후 댓글 목록을 새로고침합니다.
          },
          error: function (error) {
            console.error('대댓글 작성 오류:', error);
          },
        });
      }

      // 댓글과 대댓글 표시 기능
      function addComments() {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';

        // 댓글과 대댓글을 서버로부터 가져오는 부분
        $.ajax({
          type: 'GET',
          url: '/api/comments',
          success: function (commentsData) {
            commentsData.forEach((comment, commentIndex) => {
              if (!comment.hasOwnProperty('replies')) {
                comment.replies = [];
              }

              const commentElement = `
                <li>
                  <div class="comment-main-level">
                    <div class="comment-avatar">
                      <img src="../static/img/colony.jpg" alt="" />
                    </div>
                    <div class="comment-box">
                      <div class="comment-head">
                        <h6 class="comment-name">${comment.name}</h6>
                        <i class="fa fa-reply" data-comment-index="${commentIndex}"></i>
                      </div>
                      <div class="comment-content">${comment.content}</div>
                      <ul class="comments-list reply-list"></ul>
                    </div>
                  </div>
                </li>
              `;
              commentsList.innerHTML += commentElement;

              const commentItem = commentsList.lastElementChild;
              addNewCommentEventListeners(commentItem);

              if (comment.replies.length > 0) {
                const replyList = commentItem.querySelector('.reply-list');

                comment.replies.forEach((reply) => {
                  const replyElement = `
                    <li>
                      <div class="comment-avatar">
                        <img src="../static/img/colony.jpg" alt="" />
                      </div>
                      <div class="comment-box">
                        <div class="comment-head">
                          <h6 class="comment-name">${reply.name}</h6>
                        </div>
                        <div class="comment-content">${reply.content}</div>
                      </div>
                    </li>
                  `;
                  replyList.innerHTML += replyElement;
                });
              }
            });
          },
          error: function (error) {
            console.error('댓글 가져오기 오류:', error);
          },
        });
      }

      function addNewCommentEventListeners(commentItem) {
        const replyButton = commentItem.querySelector('.fa-reply');
        replyButton.removeEventListener('click', onClickAddReplyButton); // 기존 이벤트 리스너 제거
        replyButton.addEventListener('click', onClickAddReplyButton);

        // 대댓글 작성 버튼에 대한 이벤트 리스너를 추가합니다.
        const replyWriteBtn = commentItem.querySelectorAll('.reply-write-btn');
        replyWriteBtn.forEach((button) => {
          button.removeEventListener('click', onReplyWriteButtonClick); // 기존 이벤트 리스너 제거
          button.addEventListener('click', onReplyWriteButtonClick);
        });
      }

      function onReplyWriteButtonClick(event) {
        const button = event.target.closest('.reply-write-btn');
        if (!button) return;

        const commentIndex = button.closest('.comment-main-level').querySelector('.fa-reply')
          .dataset.commentIndex;
        const commentItem = button.closest('li');
        const replyList = commentItem.closest('ul.reply-list');

        const inputReply = replyList.querySelector('.inputReply');
        const newReplyText = inputReply.value;

        const newReply = {
          name: userName, //현재 로그인중인 유저네임!
          content: newReplyText,
        };

        // 새 대댓글을 서버로 전송합니다.
        $.ajax({
          type: 'POST',
          url: `/api/comments/${commentIndex}/replies`,
          contentType: 'application/json',
          data: JSON.stringify(newReply),
          success: function () {
            addComments(); // 대댓글 작성 후 댓글 목록을 새로고침합니다.
          },
          error: function (error) {
            console.error('대댓글 작성 오류:', error);
          },
        });
      }

      function addReplyButtonClickHandler() {
        const replyButtons = document.querySelectorAll('.comment-head .fa-reply');
        replyButtons.forEach((button) => {
          button.removeEventListener('click', onClickAddReplyButton);
          button.addEventListener('click', onClickAddReplyButton);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        addReplyButtonClickHandler();
        fetchAnswers();
        addComments();
        addReplyButtonClickHandler();
      });

      const writeButton = document.getElementById('add-comment-button');
      writeButton.addEventListener('click', onWriteButtonClick);

      const commentsList = document.getElementById('comments-list');
      commentsList.addEventListener('click', (event) => {
        if (event.target.matches('.fa-reply')) {
          onClickAddReplyButton(event);
        } else if (event.target.matches('.reply-write-btn')) {
          onReplyWriteButtonClick(event);
        }
      });
    </script>

    <div th:replace="~{layouts/footer :: footer}"></div>
  </body>
</html>
