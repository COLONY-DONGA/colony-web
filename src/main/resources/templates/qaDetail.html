<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../static/css/qaDetail.css" />
    <link rel="stylesheet" href="../static/css/headerfooter.css" />
    <title>질문 세부 페이지</title>
  </head>

  <body>
    <script>
      $(function () {
        $('#header').load('header.html');
        $('#footer').load('footer.html');
      });
    </script>

    <div id="header"></div>
    <br />

    <div class="qadetail-frame">
      <section class="article-detail table-common con row">
        <table class="cell" border="1">
          <colgroup>
            <col width="100px" />
          </colgroup>
          <tbody>
            <tr class="article-title">
              <th>제목</th>
              <td class="question-title" th:text="Q. : ${title}">title</td>
              <th>작성자</th>
              <td class="question-title" th:text="Q. : ${name}">name</td>
            </tr>
            <tr class="article-info">
              <th>날짜</th>
              <td th:text="qadate">date</td>
              <th>좋아요</th>
              <td th:text="qagood">qagood</td>
            </tr>
            <tr class="article-body">
              <td colspan="4" th:text="A. : ${question.detail}">
                내용이 와다다다다 들어갈 것입니당
              </td>
            </tr>
          </tbody>
        </table>
      </section>
      <br />

      <div class="answer-text-box">
        <!--답변이 있으면 답변 띄우기
            답변이 없으면 display 숨기기
             넴모넴모 텍스트가 들어갈 박스 만들기, js display 처리하기 -->
        <textarea class="answer-text" th:text="${answerdata!!!!}">
        <!--답변데이터가 타임리프로 이곳에 들어갈 예정입니다 뭐지 주석인데 왜보이지-->
      </textarea
        >
      </div>

      <div class="btn">
        <button class="qabtn">답변 등록</button>
        <button class="listbtn">목록</button>
        <button class="editbtn">수정</button>
        <button class="deletebtn">삭제</button>
        <!--<a href="#" class="btn green rounded">Button</a>-->
      </div>
    </div>

    <br />

    <div class="comment-text-box">
      <div class="comment-text">
        <div id="comments"></div>
      </div>
    </div>
    <button class="new-comment-btn" id="add-comment-button">새 댓글 추가</button>

    <div id="footer"></div>

    <script>
      var userName = 'hyeon'; // 유저네임!!!(백에서 던져주는 유저네임 변수
      // [[${userName}]] 이런식으로 타임리프 식으로 사용 가능
      function addReply(event) {
        var comment = event.target.parentElement;
        var reply = document.createElement('div');
        reply.classList.add('reply');

        // 대댓글 작성자와 내용 표시
        var replyAuthorSpan = document.createElement('span');
        replyAuthorSpan.classList.add('name');
        replyAuthorSpan.innerText = '↳(' + userName + ') ';
        var replyContentInput = document.createElement('input');
        replyContentInput.placeholder = '대댓글 내용';

        // 대댓글 작성 버튼 추가
        var replySubmitButton = document.createElement('button');
        replySubmitButton.innerText = '작성';
        replySubmitButton.addEventListener('click', function () {
          var name = replyAuthorSpan.innerText; // 대댓글 작성자를 가져옴
          var text = replyContentInput.value;

          // 대댓글 생성 및 추가
          var replyContent = document.createElement('span');
          replyContent.classList.add('text');
          replyContent.innerText = text;
          var replyAuthor = document.createElement('span');
          replyAuthor.classList.add('name');
          replyAuthor.innerText = name;
          reply.appendChild(replyAuthor);
          reply.appendChild(replyContent);
          comment.getElementsByClassName('replies')[0].appendChild(reply);

          // 입력 폼 삭제
          reply.removeChild(replyAuthorSpan);
          reply.removeChild(replyContentInput);
          reply.removeChild(replySubmitButton);

          // 대댓글을 서버로 전송하여 저장
          var commentId = comment.dataset.commentId;
          saveReply(commentId, name, text);
        });

        // 대댓글 작성 폼 추가
        reply.appendChild(replyAuthorSpan);
        reply.appendChild(replyContentInput);
        reply.appendChild(replySubmitButton);
        comment.getElementsByClassName('replies')[0].appendChild(reply);
      }

      function saveComment(name, text) {
        // 새 댓글을 서버로 전송하여 저장
        $.ajax({
          type: 'POST',
          url: '/save-comment',
          contentType: 'application/json',
          data: JSON.stringify({
            name: name, //오른쪽이 js변수 새댓글 작성자 name
            text: text, //오른쪽이 js변수 새댓글 댓글텍스트
          }),
          success: function (response) {
            console.log(response);
          },
          error: function (xhr, status, error) {
            console.error(error);
          },
        });
      }

      function saveReply(commentId, name, text) {
        // 대댓글을 서버로 전송하여 저장
        $.ajax({
          type: 'POST',
          url: '/save-reply',
          contentType: 'application/json',
          dataType: 'json',
          data: JSON.stringify({
            commentId: commentId, //오른쪽 부모댓글!!! name,text가 속해있는 댓글의 식별자
            name: name, //오른쪽이 js변수 대댓글 작성자 name
            text: text, //오른쪽이 js변수 대댓글 텍스트
          }),
          success: function (response) {
            console.log(response);
          },
          error: function (xhr, status, error) {
            console.error(error);
          },
        });
      }

      // 대댓글 버튼 클릭 이벤트 처리
      function addReplyButtonListeners() {
        var replyButtons = document.getElementsByClassName('reply-button');
        for (var i = 0; i < replyButtons.length; i++) {
          replyButtons[i].addEventListener('click', addReply);
        }
      }

      // 새 댓글 추가 버튼 클릭 이벤트 처리
      var addCommentButton = document.getElementById('add-comment-button');
      addCommentButton.addEventListener('click', function () {
        var commentsDiv = document.getElementById('comments');
        var newComment = document.createElement('div');
        newComment.classList.add('comment');

        // 댓글 작성자와 내용 표시
        var commentAuthorSpan = document.createElement('span');
        commentAuthorSpan.classList.add('name');
        commentAuthorSpan.innerText = userName + ' : ';
        var commentContentInput = document.createElement('input');
        commentContentInput.placeholder = '댓글 내용';

        // 입력 버튼 추가
        var commentSubmitButton = document.createElement('button');
        commentSubmitButton.innerText = '입력';

        // 대댓글 버튼 추가
        var replyButton = document.createElement('button');
        replyButton.classList.add('reply-button');
        replyButton.innerText = '대댓글';

        // 대댓글 목록 추가
        var repliesDiv = document.createElement('div');
        repliesDiv.classList.add('replies');

        newComment.appendChild(commentAuthorSpan);
        newComment.appendChild(commentContentInput);
        newComment.appendChild(commentSubmitButton);
        newComment.appendChild(replyButton);
        newComment.appendChild(repliesDiv);

        commentsDiv.appendChild(newComment);

        // 입력 버튼 클릭 이벤트 처리
        commentSubmitButton.addEventListener('click', function () {
          var name = commentAuthorSpan.innerText; // 댓글 작성자를 가져옴
          var text = commentContentInput.value;

          // 댓글 생성 및 추가
          var commentContent = document.createElement('span');
          commentContent.classList.add('text');
          commentContent.innerText = text;
          var commentAuthor = document.createElement('span');
          commentAuthor.classList.add('name');
          commentAuthor.innerText = name;
          newComment.insertBefore(commentAuthor, commentContentInput);
          newComment.insertBefore(commentContent, commentContentInput);

          // 입력 폼 삭제
          newComment.removeChild(commentAuthorSpan);
          newComment.removeChild(commentContentInput);
          newComment.removeChild(commentSubmitButton);

          // 댓글을 서버로 전송하여 저장
          saveComment(name, text);

          // 대댓글 버튼 활성화
          replyButton.disabled = false;
        });

        // 대댓글 버튼 클릭 이벤트 처리
        replyButton.addEventListener('click', addReply);

        // 댓글이 추가되었으므로 대댓글 버튼을 비활성화
        replyButton.disabled = true;
      });

      // 페이지 로드 시에 댓글이 없으므로 대댓글 버튼 비활성화
      var replyButtons = document.getElementsByClassName('reply-button');
      for (var i = 0; i < replyButtons.length; i++) {
        replyButtons[i].disabled = true;
      }

      // 페이지 로드 시에 기존 댓글과 대댓글을 가져와서 표시하는 함수
      function loadComments() {
        // 서버에서 댓글 데이터를 가져오는 Ajax 요청
        $.ajax({
          type: 'GET',
          url: '/get-comments',
          success: function (response) {
            // 가져온 댓글 데이터를 반복하여 표시
            for (var i = 0; i < response.comments.length; i++) {
              var commentData = response.comments[i];

              // 댓글 요소 생성
              var newComment = document.createElement('div');
              newComment.classList.add('comment');

              // 댓글 작성자와 내용 표시
              var commentAuthor = document.createElement('span');
              commentAuthor.classList.add('name');
              commentAuthor.innerText = commentData.name + ' : ';
              var commentContent = document.createElement('span');
              commentContent.classList.add('text');
              commentContent.innerText = commentData.text;

              newComment.appendChild(commentAuthor);
              newComment.appendChild(commentContent);

              // 대댓글 목록 추가
              var repliesDiv = document.createElement('div');
              repliesDiv.classList.add('replies');
              newComment.appendChild(repliesDiv);

              // 대댓글 작성 버튼 추가
              var replyButton = document.createElement('button');
              replyButton.classList.add('reply-button');
              replyButton.innerText = '대댓글';
              newComment.appendChild(replyButton);

              // 댓글에 대댓글 버튼 클릭 이벤트 처리
              replyButton.addEventListener('click', addReply);

              // 댓글을 댓글 목록에 추가
              var commentsDiv = document.getElementById('comments');
              commentsDiv.appendChild(newComment);

              // 해당 댓글의 대댓글 가져와서 표시
              for (var j = 0; j < commentData.replies.length; j++) {
                var replyData = commentData.replies[j];
                var reply = document.createElement('div');
                reply.classList.add('reply');

                // 대댓글 작성자와 내용 표시
                var replyAuthor = document.createElement('span');
                replyAuthor.classList.add('name');
                replyAuthor.innerText = '↳(' + replyData.name + ') ';
                var replyContent = document.createElement('span');
                replyContent.classList.add('text');
                replyContent.innerText = replyData.text;

                reply.appendChild(replyAuthor);
                reply.appendChild(replyContent);
                repliesDiv.appendChild(reply);
              }
            }

            // 대댓글 버튼 활성화
            addReplyButtonListeners();
          },
          error: function (xhr, status, error) {
            console.error(error);
          },
        });
      }

      // 페이지 로드 시에 기존 댓글 가져오기
      loadComments();
    </script>
  </body>
</html>
