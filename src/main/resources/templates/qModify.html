<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/qEnrollModify.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>qModify</title>
</head>
<body>
<div th:replace="~{layouts/header :: header}"></div>

<div class="frame">
  <div class="container">
    <div class="question-modify">Question Modify</div>
    <form th:action="@{/edit-post/{postId}(postId=${postId})}" method="post" enctype="multipart/form-data">
      <div class="enroll-form">
        <div class="title-box">
          <label for="title">Title</label>
          <input type="text" id="title" name="title" th:value="${postFormDto.title}" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        </div>
        <div class="content-box">
          <label for="content">Content</label>
          <textarea id="content" name="content" th:text="${postFormDto.content}" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
        </div>
        <div class="image-box">
          <input type="file" id="file-input" name="imageList" accept="image/jpeg, image/png" style="display: none" multiple />
          <label for="file-input" class="input-imageList">üìÅAdd file</label>
          <div id="file-list-box">
            <ul id="file-list"></ul>
          </div>
        </div>
      </div>
      <div class="button-group">
        <button type="submit" class="submit-btn">Modify</button>
        <button type="button" class="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div th:replace="~{layouts/footer :: footer}"></div>

<input type="hidden" class="getPostId" th:value="${postFormDto.postId}" />

<script th:inline="javascript">
  /*<![CDATA[*/
  let uploadedImages = /*[[${postFormDto.imageDtoList}]]*/ [];
  /*]]>*/

  console.log(uploadedImages);

  let fileInput = document.getElementById('file-input');
  let fileList = document.getElementById('file-list');
  let cancelBtn = document.querySelector('.cancel-btn');
  let getPostId = document.querySelector('.getPostId').value;

  fileInput.addEventListener('change', () => {
    let selectedFiles = Array.from(fileInput.files);
    selectedFiles.forEach((file) => {
      let listItem = document.createElement('li');
      listItem.classList.add('file-list-item');

      let filePreview = document.createElement('img');
      filePreview.classList.add('file-preview');
      let reader = new FileReader();
      reader.onload = function (e) {
        resizeImage(e.target.result, 300, 300, (resizedImage) => {
          filePreview.src = resizedImage;
        });
      };
      reader.readAsDataURL(file);
      listItem.appendChild(filePreview);

      let fileInfo = document.createElement('span');
      fileInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
      listItem.appendChild(fileInfo);

      let deleteButton = document.createElement('button');
      deleteButton.textContent = 'Delete';
      deleteButton.classList.add('delete-btn');
      deleteButton.addEventListener('click', () => {
        listItem.remove();
        let fileIndex = selectedFiles.indexOf(file);
        if (fileIndex !== -1) {
          selectedFiles.splice(fileIndex, 1);
          const newFileList = new DataTransfer();
          selectedFiles.forEach((file) => {
            newFileList.items.add(file);
          });
          fileInput.files = newFileList.files;
        }
      });
      listItem.appendChild(deleteButton);
      fileList.appendChild(listItem);
    });
  });

  function formatFileSize(size) {
    if (size === 0) return '0 Bytes';
    let units = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    let i = Math.floor(Math.log(size) / Math.log(1024));
    return `${parseFloat((size / Math.pow(1024, i)).toFixed(2))} ${units[i]}`;
  }

  function resizeImage(src, maxWidth, maxHeight, callback) {
    let img = new Image();
    img.onload = function () {
      let width = img.width;
      let height = img.height;
      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width *= maxHeight / height;
          height = maxHeight;
        }
      }
      let canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      let resizedImage = canvas.toDataURL('image/jpeg');
      callback(resizedImage);
    };
    img.src = src;
  }

  function displayUploadedImages() {
    uploadedImages.forEach((imageDto) => {
      let listItem = document.createElement('li');
      listItem.classList.add('file-list-item');

      let filePreview = document.createElement('img');
      filePreview.classList.add('file-preview');
      filePreview.src = imageDto.s3Url;
      listItem.appendChild(filePreview);

      let fileInfo = document.createElement('span');
      fileInfo.textContent = imageDto.originImageName;
      listItem.appendChild(fileInfo);

      let deleteButton = document.createElement('button');
      deleteButton.textContent = 'Delete';
      deleteButton.classList.add('delete-btn');
      deleteButton.addEventListener('click', () => {
        listItem.remove();
      });
      listItem.appendChild(deleteButton);
      fileList.appendChild(listItem);
    });
  }

  displayUploadedImages();

  cancelBtn.addEventListener('click', () => {
    location.href = '/post/' + getPostId;
  });
</script>
</body>
</html>
