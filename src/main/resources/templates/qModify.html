<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/qEnrollModify.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>qModify</title>
  </head>

  <body>
    <div th:replace="~{layouts/header :: header}"></div>

    <div class="frame">
      <div class="container">
        <div class="question-modify">Question Modify</div>
        <form
          id="postEditForm"
          th:action="@{/edit-post/{postId}(postId=${postId})}"
          method="post"
          enctype="multipart/form-data"
        >
          <div class="enroll-form">
            <div class="title-box">
              <label for="title">Title</label>
              <input
                type="text"
                id="title"
                name="title"
                th:value="${postFormDto.title}"
                placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              />
            </div>
            <div class="content-box">
              <label for="content">Content</label>
              <textarea
                id="content"
                name="content"
                th:text="${postFormDto.content}"
                placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
              ></textarea>
            </div>
            <div class="old-image-box">
              <div class="old-image-1">Old Image</div>
              <div class="old-image-2" >
                <ul class="old-image-3"></ul>
              </div>
              <input type="hidden" id="deleteImageIdList" name="deleteImageList" />
            </div>
            <div class="image-box">
              <input
                type="file"
                id="file-input"
                name="imageList"
                accept="image/jpeg, image/png"
                style="display: none"
                multiple
              />
              <label for="file-input" class="input-imageList">ğŸ“Add file</label>
              <div id="file-list-box">
                <ul id="file-list"></ul>
              </div>
            </div>
          </div>
          <div class="button-group">
            <button type="submit" class="submit-btn">Modify</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div th:replace="~{layouts/footer :: footer}"></div>

    <input type="hidden" class="getPostId" th:value="${postFormDto.postId}" />

    <script th:inline="javascript">
      /*<![CDATA[*/
      let uploadedImages = /*[[${postFormDto.imageDtoList}]]*/ [];
      /*]]>*/

      let fileInput = document.getElementById('file-input');
      let fileList = document.getElementById('file-list');
      let cancelBtn = document.querySelector('.cancel-btn');
      let getPostId = document.querySelector('.getPostId').value;
      let allSelectedFiles = [];
      let deleteImageIdList = [];

      // íŒŒì¼ ì…ë ¥ ê°’ì´ ë³€ê²½ë  ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€
      fileInput.addEventListener('change', () => {
        // ì„ íƒëœ íŒŒì¼ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥
        let selectedFiles = Array.from(fileInput.files);
        // ì„ íƒëœ íŒŒì¼ë“¤ì„ ì „ì²´ ì„ íƒëœ íŒŒì¼ë“¤ ë°°ì—´ì— ì¶”ê°€
        allSelectedFiles = allSelectedFiles.concat(selectedFiles);

        // ì „ì²´ ì„ íƒëœ íŒŒì¼ ëª©ë¡ì„ ì—…ë°ì´íŠ¸
        const newFileList = new DataTransfer();
        allSelectedFiles.forEach((file) => {
          newFileList.items.add(file);
        });
        fileInput.files = newFileList.files;

        // ì„ íƒëœ íŒŒì¼ë“¤ì„ ë°˜ë³µí•˜ë©´ì„œ ê° íŒŒì¼ì— ëŒ€í•´ ì‹¤í–‰ë  ì½”ë“œë¥¼ ì •ì˜
        selectedFiles.forEach((file) => {
          // ìƒˆë¡œìš´ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì¸ <li> ìš”ì†Œë¥¼ ìƒì„±
          let listItem = document.createElement('li');
          // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì— í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ ì´ë¦„ ì¶”ê°€
          listItem.classList.add('file-list-item');

          // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë¥¼ ìœ„í•œ <img> ìš”ì†Œë¥¼ ìƒì„±
          let filePreview = document.createElement('img');
          filePreview.classList.add('file-preview');
          let reader = new FileReader();

          // íŒŒì¼ì´ ë¡œë“œë˜ì—ˆì„ ë•Œ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì¡°ì •í•˜ê³  ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œì˜ ì†ŒìŠ¤ë¡œ ì„¤ì •
          reader.onload = function (e) {
            resizeImage(e.target.result, 300, 300, (resizedImage) => {
              filePreview.src = resizedImage;
            });
          };

          // íŒŒì¼ì„ ë°ì´í„° URLë¡œ ì½ìŒ
          reader.readAsDataURL(file);
          listItem.appendChild(filePreview);

          // íŒŒì¼ ì •ë³´(ì´ë¦„ê³¼ í¬ê¸°)ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•œ <span> ìš”ì†Œë¥¼ ìƒì„±
          let fileInfo = document.createElement('span');
          // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì˜ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ íŒŒì¼ ì´ë¦„ê³¼ íŒŒì¼ í¬ê¸°ë¡œ ì„¤ì •
          fileInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
          listItem.appendChild(fileInfo);

          let deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete';
          deleteButton.classList.add('delete-btn');

          // ì‚­ì œ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€
          deleteButton.addEventListener('click', () => {
            listItem.remove();

            // íŒŒì¼ inputì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì‚­ì œ
            let fileIndex = allSelectedFiles.indexOf(file);
            if (fileIndex !== -1) {
              allSelectedFiles.splice(fileIndex, 1);

              // ì „ì²´ ì„ íƒëœ íŒŒì¼ ëª©ë¡ì„ íŒŒì¼ inputì˜ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
              const newFileList = new DataTransfer();
              allSelectedFiles.forEach((file) => {
                newFileList.items.add(file);
              });
              fileInput.files = newFileList.files;
            }
          });

          listItem.appendChild(deleteButton);
          fileList.appendChild(listItem);
        });
      });

      // íŒŒì¼ í¬ê¸°ë¥¼ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      function formatFileSize(size) {
        if (size === 0) return '0 Bytes'; // íŒŒì¼ í¬ê¸°ê°€ 0ì¸ ê²½ìš° '0 Bytes'ë¥¼ ë°˜í™˜
        let units = ['Bytes', 'KB', 'MB', 'GB', 'TB']; // íŒŒì¼ í¬ê¸° ë‹¨ìœ„ë¥¼ ì •ì˜
        let i = Math.floor(Math.log(size) / Math.log(1024)); // íŒŒì¼ í¬ê¸°ë¥¼ 1024ë¡œ ë‚˜ëˆ„ì–´ ë‹¨ìœ„ë¥¼ ê²°ì •
        return `${parseFloat((size / Math.pow(1024, i)).toFixed(2))} ${units[i]}`; // ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ íŒŒì¼ í¬ê¸°ë¥¼ ë³€í™˜í•˜ì—¬ ë°˜í™˜
      }

      // ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
      function resizeImage(src, maxWidth, maxHeight, callback) {
        let img = new Image();
        img.onload = function () {
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }

          let canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;

          let ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          let resizedImage = canvas.toDataURL('image/jpeg');
          callback(resizedImage);
        };

        img.src = src;
      }

      // ê¸°ì¡´ ì´ë¯¸ì§€ë“¤ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
      function displayRegisteredImages(uploadedImages) {
        const imageListContainer = document.querySelector('.old-image-3');

        uploadedImages.forEach((imageDto) => {
          const listItem = document.createElement('li');
          listItem.classList.add('file-list-item');

          let fileInfo = document.createElement('span');
          fileInfo.textContent = imageDto.originImageName;
          listItem.appendChild(fileInfo);

          let deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete';
          deleteButton.classList.add('delete-btn');

          deleteButton.addEventListener('click', () => {
            listItem.remove();

            let fileIndex = uploadedImages.indexOf(imageDto);
            if (fileIndex !== -1) {
              uploadedImages.splice(fileIndex, 1);
            }

            deleteImageIdList.push(imageDto.storeImageName);
            document.getElementById('deleteImageIdList').value = deleteImageIdList.join(',');
            console.log(deleteImageIdList.length); // ì‚­ì œ ì˜ˆì •
          });

          listItem.appendChild(deleteButton);
          imageListContainer.appendChild(listItem);
        });
      }

      displayRegisteredImages(uploadedImages);

      cancelBtn.addEventListener('click', () => {
        deleteImageIdList = [];
        console.log(deleteImageIdList.length); // ì‚­ì œ ì˜ˆì •
        location.href = '/post/' + getPostId;
      });


      document.querySelector(".submit-btn").addEventListener("click", (e) => {
        e.preventDefault();

        let formData = new FormData(document.getElementById("postEditForm"));

        $.ajax({
          url: `/edit-post/${getPostId}`,
          type: "POST",
          enctype: "multipart/form-data",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ ê²½ìš°
            console.log("ìˆ˜ì • ì™„ë£Œ");
            location.href = `/post/${getPostId}`; // ìˆ˜ì •ëœ ê²Œì‹œë¬¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          },
          error: function (err) {
            // ìš”ì²­ì´ ì‹¤íŒ¨í•œ ê²½ìš°
            console.error("ì˜¤ë¥˜ ë°œìƒ: ", err);
            alert("ê²Œì‹œë¬¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          },
        });
      });
    </script>
  </body>
</html>
