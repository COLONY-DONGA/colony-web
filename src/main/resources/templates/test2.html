<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../static/css/qaDetail.css" />
    <link rel="stylesheet" href="../static/css/headerfooter.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <title>질문 세부 페이지</title>
  </head>

  <body>
    <!--  로그인 유저 닉네임-->
    <div sec:authorize="isAuthenticated()">
      <span
        class="member-nickname"
        sec:authentication="principal.nickname"
        style="display: none"
      ></span>
    </div>
    <div sec:authorize="isAnonymous()">
      <span class="member-nickname" value="" style="display: none"></span>
    </div>

    <div th:replace="~{layouts/header :: header}"></div>
    <br />
    <br />
    <br />

    <div class="qadetail-frame">
      <div class="q-box">
        <div class="horizontal-line"></div>
        <div class="q-head">
          <div class="question-title" th:text="${postDto.title}">title</div>
          <div class="question-info">
            <span id="post-writer" class="question-info-writer" th:text="${postDto.createdBy}"
              >작성자</span
            >
            <span class="small-line"> | </span>
            <span class="question-info-date" th:text="${postDto.updatedAt}">date</span>
          </div>

          <br />
          <br />
          <hr />
          <!--<tr class="article-info">
              <th>날짜</th>
              <td th:text="${postDto.updatedAt}">date</td>
            </tr> -->

          <!--내용칸-->
        </div>

        <div class="question-area" th:text="${postDto.content}">Q. question area</div>

        Q. question area

        <input id="postId" type="hidden" th:value="${postDto.postId}" />
        <!--포스트아이디-->

        ----------<!--질문 첨부파일 이미지+이미지명 출력파트-->
        <div class="file-box">
          <!-- Loop through the file list -->
          <div th:each="file : ${postDto.imageDtoList}">
            <div class="file-img">
              <img th:src="|/images/${file.storeImageName}|" alt="이미지" />
            </div>
          </div>
        </div>

        <!--버튼바들-->
        <div class="tool-box" id="question-tool-box">
          <div class="btn">
            <button class="qabtn" id="qabtn">
              <i class="fa-keyboard-o"></i>
              답변하기
            </button>
            <!--<button class="listbtn" id="listbtn">목록</button>-->
            <button class="editbtn" id="editbtn">수정</button>
            <button class="deletebtn" id="deletebtn">삭제</button>
            <!--<a href="#" class="btn green rounded">Button</a>-->
          </div>
        </div>
      </div>
      <br />
      <br />

      <br />

      <div class="answer-box" id="answer-box">
        <div class="horizontal-line"></div>
        <div class="a-head">
          <div class="answer-title">
            <span class="answer-label">답변</span>
            <!--타임리프 필요-->
            <span class="answer-number">1</span>
          </div>
          <div class="answer-info">
            <span id="answer-writer" class="answer-info-writer" th:text="${postDto.createdBy}"
              >작성자</span
            >
            <span class="small-line"> | </span>
            <span class="answer-info-date" th:text="${answerDto.updatedAt}">date</span>
          </div>
        </div>

        <div th:each="answer : ${answerList}" class="answer-text" id="answer-box-[[${answer.id}]]">
          <!-- 답변데이터가 타임리프로 이곳에 들어갈 예정입니다 -->
          <div class="answer-area" th:text="${'A. : ' + answer.content}">A.answer content</div>
        </div>

        <!--파일-->
        --파일,이미지 기능

        <div class="tool-box" id="answer-tool-box">
          <button class="heart-button"><i class="fa fa-heart"></i></button>
          <div class="likecount" id="like">1</div>
          <div class="btn">
            <button class="editbtn" id="editbtn">수정</button>
            <button class="deletebtn" id="deletebtn">
              <i class="fa fa-trash" id="answer-deletebtn"></i>
            </button>
            <!--<a href="#" class="btn green rounded">Button</a>-->
          </div>
        </div>

        <br />

        <div class="comments-container">
          <ul id="comments-list" class="comments-list">
            <!-- 댓글이 여기에 추가될 예정 -->
          </ul>
          <!-- 새댓글 작성부분 -->
          <div class="input-box">
            <div class="inputframe">
              <br />

              <h5>New Comment : <input type="text" class="input-text" id="newComment" /></h5>
              <button class="new-comment-btn" id="add-comment-button">작성</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="footer"></div>

    <script>
      // [[${userName}]] 이런식으로 타임리프 식으로 사용 가능
      let userName = $('#member-nickname').val(); // 로그인 유저
      let name = $('#post-writer').val(); // post 작성자
      let postId = $('#postId').val();

      /*var qabtn = document.getElementById('qabtn'); //답변등록 버튼
      qabtn.addEventListener('click', function () {
        window.open('/answer/' + postId, 'aEnroll');
      });

      var listbtn = document.getElementById('listbtn'); //목록 버튼
      listbtn.addEventListener('click', function () {
        location.href = '/post-list';
      });

      var editbtn = document.getElementById('editbtn'); //수정 버튼
      editbtn.addEventListener('click', function () {
        location.href = 'edit-post/' + postId;
      });

      var deletebtn = document.getElementById('deletebtn'); //삭제 버튼
      deletebtn.addEventListener('click', function () {
        location.href = '/delete-post/' + postId;
      });

      if (userName != name || userName === '') {
        editbtn.style.display = 'none';
        deletebtn.style.display = 'none';
      }*/
      //관리자일때도 권한 추가해야함

      //좋아요 기능 구현(질문글 좋아요)
      var qlikeCount = 0;

      // qlikeBtn 클릭 이벤트 처리 코드 이상함 수정필요
      $('#heart-button').on('click', function () {
        // class 변경
        if ($(this).hasClass('likeButton')) {
          $(this).removeClass('#heart-button').addClass('#heart-button-use'); // 색상 변경
          // qlikeCount 증가 (이 친구가 나중에 ajax통신으로 질문에 대한 좋아요로 들어갈 것임)
        } else {
          $(this).removeClass('#heart-button-use').addClass('#heart-button');
        }
        $('#qlikeCount').text(qlikeCount);

        // 서버로 ajax 요청
        $.ajax({
          url: 'localhost:8080/~~~/',
          type: 'POST',
          dataType: 'json',
          data: { answerId: answerId },
          success: function (response) {
            // 서버 응답 처리
            console.log(response);
          },
          error: function (error) {
            // 에러 처리
            console.error(error);
          },
        });
      });

      //css 관련 코드!  css 관련 코드!  css 관련 코드!  css 관련 코드!  css 관련 코드!

      // 문서가 로드되면 요소의 크기를 자동으로 조정합니다.
      window.addEventListener('load', function () {
        adjustQuestionAreaHeight();
      });

      // 뷰포트 크기가 변경될 때마다 요소의 크기를 다시 조정합니다.
      window.addEventListener('resize', function () {
        adjustQuestionAreaHeight();
      });

      // 요소의 높이를 조정하는 함수
      function adjustQuestionAreaHeight() {
        var qBox = document.getElementById('q-box');
        var questionArea = document.getElementById('question-area');
        var maxHeight = qBox.offsetHeight;
        questionArea.style.height = maxHeight + 'px';
      }

      // answer-area css부분
      document.addEventListener('DOMContentLoaded', function () {
        const answerAreas = document.querySelectorAll('.answer-area');
        for (const answerArea of answerAreas) {
          adjustAnswerAreaHeight(answerArea);
        }
      });

      // answer-area의 높이를 자동으로 조절하는 함수
      function adjustAnswerAreaHeight(element) {
        element.style.height = 'auto'; // 높이 초기화
      }

      //수정
      const commentsData = [
        {
          name: '최유현',
          content: '첫번째 댓글~~~.',
          replies: [
            { name: '최쌤 대댓글1', content: 'ㅁㄴㅇㅁㄴㅇㅁㄴㅇㅁㄴㅇ' },
            { name: '최쌤 대댓글2', content: 'ㅁㄴㅇㅁㄴㅇㅁㄴㅇㅁㄴㅇㅁㄴㅇ' },
          ],
        },
        {
          name: '김진짜',
          content: '두번쨰 댓글~~~',
          replies: [{ name: '김진수', content: 'blalbalbalbalba' }],
        },
      ];

      function onWriteButtonClick() {
        const newCommentInput = document.getElementById('newComment');
        const newCommentText = newCommentInput.value;

        commentsData.push({
          name: '사용자',
          content: newCommentText,
          replies: [],
        });

        addComments();

        newCommentInput.value = '';
      }

      const writeButton = document.getElementById('add-comment-button');
      writeButton.addEventListener('click', onWriteButtonClick);

      function onClickAddReplyButton(event) {
        const button = event.target.closest('.fa-reply'); // Modify this line
        const commentIndex = button.dataset.commentIndex;
        const commentItem = button.closest('li');
        const replyList = commentItem.querySelector('.reply-list');

        const newReplyElement = `
          <li class="new-reply">
            <div class="comment-avatar">
              <img src="../static/img/colony.jpg" alt="" />
            </div>
            <div class="comment-box">
              <div class="comment-head">
                <h6 class="comment-name">New Reply</h6>
              </div>
              <div class="comment-content"><input type="text" class="inputReply" /></div>
              <button class="reply-write-btn">작성</button>
            </div>
          </li>
        `;

        replyList.innerHTML += newReplyElement;

        const replyWriteBtn = replyList.querySelector('.reply-write-btn');
        replyWriteBtn.addEventListener('click', () => {
          const inputReply = replyList.querySelector('.inputReply');
          const newReplyText = inputReply.value;

          commentsData[commentIndex]['replies'].push({
            name: '사용자',
            content: newReplyText,
          });

          addComments();
        });
      }
      function addNewCommentEventListeners(commentItem) {
        const replyButton = commentItem.querySelector('.fa-reply');
        replyButton.addEventListener('click', onClickAddReplyButton);
      }

      function addReplyButtonClickHandler() {
        const replyButtons = document.querySelectorAll('.comment-head .fa-reply');
        replyButtons.forEach((button) => {
          button.removeEventListener('click', onClickAddReplyButton);
          button.addEventListener('click', onClickAddReplyButton);
        });
      }

      function addComments() {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';

        commentsData.forEach((comment, commentIndex) => {
          if (!comment.hasOwnProperty('replies')) {
            comment.replies = [];
          }

          const commentElement = `
              <li>
                <div class="comment-main-level">
                  <div class="comment-avatar">
                    <img src="../static/img/colony.jpg" alt="" />
                  </div>
                  <div class="comment-box">
                    <div class="comment-head">
                      <h6 class="comment-name">${comment.name}</h6>
                      <i class="fa fa-reply" data-comment-index="${commentIndex}"></i>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <ul class="comments-list reply-list"></ul>
                  </div>
                </div>
              </li>
            `;
          commentsList.innerHTML += commentElement;

          const commentItem = commentsList.lastElementChild;
          addNewCommentEventListeners(commentItem);

          if (comment.replies.length > 0) {
            const replyList = commentItem.querySelector('.reply-list');

            comment.replies.forEach((reply) => {
              const replyElement = `
                  <li>
                    <div class="comment-avatar">
                      <img src="../static/img/colony.jpg" alt="" />
                    </div>
                    <div class="comment-box">
                      <div class="comment-head">
                        <h6 class="comment-name">${reply.name}</h6>
                      </div>
                      <div class="comment-content">${reply.content}</div>
                    </div>
                  </li>
                `;
              replyList.innerHTML += replyElement;
            });
          }
        });
      }
      document.addEventListener('DOMContentLoaded', () => {
        addComments();
        addReplyButtonClickHandler();
      });

      commentsList.addEventListener('click', (event) => {
        if (event.target.matches('.fa-reply')) {
          onClickAddReplyButton(event);
        }
      });
    </script>

    <div th:replace="~{layouts/footer :: footer}"></div>
  </body>
</html>
