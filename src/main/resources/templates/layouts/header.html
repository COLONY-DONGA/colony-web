<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  th:fragment="header"
>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../static/css/headerfooter.css" />
    <title>Header</title>
  </head>

  <body>
    <header>
      <div class="header">
        <img class="logo" src="/img/colony.jpg" />
        <div class="colony">COLONY_DAU</div>
        <div class="welcome" sec:authorize="isAuthenticated()">
          <span sec:authentication="principal.nickname">닉네임</span>&nbsp;님, 환영합니다 !
        </div>
        <div class="welcome" sec:authorize="isAnonymous()">
          <span>Guest</span>&nbsp;님, 환영합니다 !
        </div>
        <div class="nav">
          <nav>
            <ul>
              <li class="mypage" sec:authorize="isAuthenticated()">
                <a href="/my-page">My Page</a>
              </li>
              <li class="logout" sec:authorize="isAuthenticated()"><a href="/logout">Logout</a></li>
              <li class="login" sec:authorize="isAnonymous()"><a href="/login">Login</a></li>
            </ul>
            <!-- 알림 (자, 나중에 위치 수정) -->
            <div class="notification-box">
              <!-- 알림 아이콘을 오른쪽 상단에 배치합니다. -->
              <a href="#" id="notification-icon">
                <i class="fa fa-bell"></i>
                <span class="notification-badge">0</span>
                알림
              </a>
            </div>
          </nav>
        </div>
      </div>
    </header>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
      document.querySelector('.logo').addEventListener('click', () => {
        location.href = '/post-list';
      });

      // 페이지 로드 시 알림 개수를 가져와 뱃지로 표시하는 함수
      function updateNotificationBadge() {
        $.ajax({
          type: "GET",
          url: "/notifications/count",
          dataType: "json",
          success: function (data) {
            const notificationCount = parseInt(data.count);
            console.log(notificationCount);
            $('.notification-badge').text(notificationCount);
          },
          error: function (error) {
            console.error("Error fetching notification count: " + error);
          },
        });
      }

      /**
       * 알람 구독 로직
       */
      $(document).ready(function () {
        console.log('알람 구독 로직 시작');
        // 알림을 위해 SSE 연결을 수립합니다.
        const source = new EventSource('/subscribe');

        updateNotificationBadge();

        // SSE 이벤트를 처리합니다. (새로운 알림이 도착했을 때)
        source.onmessage = function (event) {
          const data = event.data;
          console.log(data);
          const notificationCount = parseInt($('.notification-badge').text());

          if (data === '연결완료') {
            return;
          } else {
            // Show the notification message as a toast using Toastr
            toastr.options = {
              closeButton: true,
              progressBar: true,
              timeOut: 3000, // Set the duration for how long the toast should be displayed (in milliseconds)
            };
            console.log(data.content);
            toastr.success('새로운 알림이 도착했습니다.'); // Display the notification message as a success toast

            // 알림 개수를 가져와 뱃지를 업데이트합니다.
          }
        };
      });
    </script>
  </body>
</html>
