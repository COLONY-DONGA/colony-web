<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  th:fragment="header"
>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" type="text/css" href="../static/css/headerfooter.css" />
    <title>Header</title>
  </head>

  <body>
    <header>
      <div class="header">
        <img class="logo" src="/img/colony.jpg" />
        <div class="colony">COLONY_DAU</div>
        <div class="welcome" sec:authorize="isAuthenticated()">
          <span sec:authentication="principal.nickname">닉네임</span>&nbsp;님, 환영합니다 !
        </div>
        <div class="welcome" sec:authorize="isAnonymous()">
          <span>Guest</span>&nbsp;님, 환영합니다 !
        </div>
        <div class="nav">
          <nav>
            <ul>
              <li class="mypage" sec:authorize="isAuthenticated()">
                <a href="/my-page">My Page</a>
              </li>
              <li class="logout" sec:authorize="isAuthenticated()"><a href="/logout">Logout</a></li>
              <li class="login" sec:authorize="isAnonymous()"><a href="/login">Login</a></li>

              <div class="notification-container">
                <button type="button" id="notification-icon" class="notification-button">
                  <i class="fa fa-bell"></i>
                  <span class="notification-badge">0</span>
                  Notice
                </button>
                <div
                  id="notification-dropdown"
                  class="header-notification-dropdown"
                  style="display: none"
                ></div>
              </div>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <script>
      document.querySelector('.logo').addEventListener('click', () => {
        location.href = '/post-list';
      });

      /**
       * 알람 구독 로직
       */
      $(document).ready(function () {
        console.log('알람 구독 로직 시작');
        // 알림을 위해 SSE 연결을 수립합니다.
        const source = new EventSource('/subscribe');

        // SSE 이벤트를 처리합니다. (새로운 알림이 도착했을 때)
        source.onmessage = function (event) {
          const data = event.data;
          console.log(data);
          const notificationCount = parseInt($('.notification-badge').text());

          if (data === '연결완료') {
            return;
          } else {
            // Show the notification message as a toast using Toastr
            toastr.options = {
              closeButton: true,
              progressBar: true,
              timeOut: 3000, // Set the duration for how long the toast should be displayed (in milliseconds)
            };
            console.log(data.content);
            toastr.success('새로운 알림이 도착했습니다.'); // Display the notification message as a success toast
            // 알림 카운트를 증가시키고 뱃지를 업데이트합니다.
            $('.notification-badge')
              .text(notificationCount + 1)
              .addClass('show-badge');
          }
        };

        // // 알림 아이콘을 클릭하는 경우를 처리합니다.
        // $('#notification-icon').on('click', function () {
        //   $('.notification-badge').removeClass('show-badge').text('0'); // 뱃지 카운트를 초기화합니다.
        //   location.href = '/notifications';
        // });

        const notificationIcon = document.getElementById('notification-icon');
        const notificationDropdown = document.getElementById('notification-dropdown');

        // 알림 아이콘 클릭 이벤트 핸들러
        notificationIcon.addEventListener('click', function (e) {
          if (notificationDropdown.style.display === 'none') {
            notificationDropdown.style.display = 'block';
            fetchNotifications();
          } else {
            notificationDropdown.style.display = 'none';
          }
        });

        // 알림 데이터를 가져와 알림 드롭다운에 로드
        async function fetchNotifications() {
          try {
            const res = await fetch('/notifications');
            const data = await res.json();

            // 알림 드롭다운 초기화
            notificationDropdown.innerHTML = '';

            data.forEach((notification) => {
              // 알림 항목 생성
              const notificationItem = document.createElement('div');
              notificationItem.className = 'notification-item';

              const link = document.createElement('a');
              link.href = notification.url;
              link.textContent = notification.content;

              notificationItem.appendChild(link);
              notificationDropdown.appendChild(notificationItem);
            });
          } catch (error) {
            console.error('Error fetching notifications:', error);
          }
        }
      });
    </script>
  </body>
</html>
